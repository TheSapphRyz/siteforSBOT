
# Документация  
## Предисловие
В этой документации будут представлены запросы от севера клиенту и обратные, а так же необходимое для БД. Все данные которые выходят за пределы программы(бд, интернет и т.д.) обязательно должны шифроваться [K-Crypt](https://github.com/TheSapphRyz/K-crypt) второй версии! 
Некоторые запросы и функции программы будут помечаться "!!!" - это запросы/функции программы, которые представлены не в финальном варианте (могут поменяться по ходу разработки).
'=' в начале - значит это запрос на сервер
## Запросы
Примечание: таблица заполнялась по ходу того, как я вспоминал, так что конкретных блоков обработки одной задачи могут быть в разных частях таблицы. И для удобства и сокращения текста я буду использовать англ. слова.

| тип | запрос| ответ | переменные | примечание |
| - | - | - | - | - |
| **txt msg** | **=**{{"t", 't'}, {'n', n}, {'i', time}, {'e', text}, {'u', uid}, {'d', id}, {'c', cid}} | {{'t', 't'}, {'s', 1}} | n - имя, cid - chat id, uid - user id, id- msg id| если ответа нет - сообщение не отправлено |
| **img msg** | **=**{{"t", 'i'}, {'n', n}, {'i', time}, {'m', m}, {'u', uid}, {'d', id}, {'w', w}, {'h', h}, {'c', cid}} | {{'t', 'i'}, {'s', 1}} | n - имя, cid - chat id, uid - user id, id - msg id, m - base64 байты изображения, w, h -высота и ширина фото | m в бд должен быть в шифровке, а не BLOB 
| **doc msg** | **=**{{'t', 'd'}, {'s', 'd'}, {'n', имя}, {'i', time}, {'b', b}, {'u', uid}, {"d", id}, {'c', cid}} | {{'t', 'd'}, {'i', did}} | n - имя, cid - chat id, uid - user id, id - msg id, b - base64 байты документа, did - id документа | сервер пересылает это сообщение без b, но с did |
| **get id** | **=**{{'t', "gni"}, {'c', cid}} | {{'t', "gni"}, {'i' id}} | cid - chat id, id - msg id | чтобы не вести учет айди на клиенте |
| **get uid** | **=**{{'t', "gnu"}, {'b', bdu}} | {{'t', "gnu"}, {'u', uid}} | bdu - ключ из .bdu, его извлекает клиент, uid - userid | Для получения uid при регистрации, если ошибка или низя - без 'u' в ответе, тогда клиент обработает ошибку |
| **login** | **=**{{'t', 'l'}, {'n' name}, {'p', p}, {'u' uid}, {'b' bdu}} | {{'t', 'l'}, {'s', 0\1}} | name - имя, p - пароль пользователя, uid - user id, bdu - ключ из .bdu, 0\1 - 0 - капут, 1 - ок | если 0 3 раза, то этот айпи банится на 6ч |
| **reg** | **=**{{'t', 'r'}, {'n' name}, {'p', p}, {'u' uid}, {'b' bdu}} | {{'t', 'r'}, {'s', 0\1}} | name - имя, p - пароль пользователя, uid - user id, bdu - ключ из .bdu, 0\1 - 0 - капут, 1 - ок | если ключ не правильный - айпи банится на день или неделю | 
| **join voice** | **=**{{'t', 'v'}, {'c', cid}, {'u', uid}} | {{'t', 'v'}, {'u', p}} | uid - user id, cid - chat id, p - список людей в войсе(uid) | если -cid, то это лс звонок и 'u' не надо, если +cid, то группа. Если какого-то пользователя нет у него в бд, то он доскачивается |
|**get users in voice** | **=**{{'t', "guv"}, {'c', cid}} | {{'t', "guv"}, {'u', p}} | cid-chatid, p - список людей в войсе (uid) | используется при выходе или подключении новых людей к войсу |
| **disconnect** | **=**{{'t', "vd"}, {'c', cid}, {'u' uid}} | {{'t', "vd"}, {'s', 0/1}} | cid - chat id, uid- user id, 0/1 0 - капут, 1 - успех | при дисконекте всем остальным отправляется новый список юзеров в войсе |
| **audio** | **=**{{'t', 'a'}, {'c', cid}, {'d', d}} | - | cid-chatid, d - base64 байты аудио потока (там около КБ пакет) | это все расшифруется и пересылается все тем, кто в войсе в группе/лс по этому cid |
| **getava** | **=**{{'t' "ga"}, {'u' uid}, {'i', time}} | {{'t', "ga"}, {'d', d}, {'i', t1me}, {'u', uid}} | uid - userid, d - base64 байты аватарки, time - время обновления старой аватарки, t1me - время обновления новой аватарки (время обновления аватарки пользователем, который ее поставил) | нужно, чтобы постоянно не скачивать аватарки |
|**getdoc** | **=**{{'t', "gd"}, {"d", did}} | {{'t', "gd"}, {'d', b}} | did - doc id, b - base64 байты документа | чтобы не скачивать все документы сразу, а только когда хочешь открыть|
| !!!**console** | **=**{{'t', 'c'}, {'d', d}} | разное | d - любая str команда из консоли или просто запрос, которого нет тут | мне лень прописывать все команды, тк их много, по мере разработки я буду присылать или обновлять файлик на гх |
## БД
Здесь обязательные таблицы - !название и таблицы, которые нужны для архитектуры сервера, которую я вижу.
Все данные обязательно должны быть зашифрованы!
**

### !юзеры.
| название | тип | для чего |
| - | - | - |
| uid | int | user id |
| name | str | имя |
| theme | int | тема оформления (для синхронизации, но можно и не делать) |
| invoice | bool/int | в войсе или нет, для значка всем пользователям |
| passw | str | пароль для входа в акк |
| bdu | str | ключ bdu, используется для получения доступа к регистрации и автоматически подставляется для логина |

### !Чаты
| название | тип | для чего |
| - | - | - |
| cid | int | chat id |
| name | str | имя чата, отображается у всех |
| nop | int | количество людей в группе |
| uig | str | uid_uid1_uid2 - список людей в группе |
| log | bool/int | лс или группа, если лс, то cid отрицательный, а nop = 0 |
| nom | int | количество сообщений |

### !Сообщения
| название | тип | для чего |
| - | - | - |
| id | int | айди сообщения |
| cid | int | айди чата |
| uid | int | userid |
| sender | str | имя отправителя |
| time | str | время отправки сообщения |
| reply | str | если первый символ '-', то ответа нет, то далее идет id сообщения и cid: id-=S=-cid
| isImage| bool | isimage?
| isText | bool | istext?
| isDoc | bool | isdoc?
| text | str | текст сообщения, если isText true |
| image64 | str | base64 байты изображения, если isImage true |
| w | float | ширина фото |
| h | float | высота фото |
| did | int | id документа, чтобы он автоматически не скачивался |
| doc64 | str | base64 байты документа, если isDoc true |

### !Аватарки
| название | тип | для чего |
| - | - | - |
| uid | int | uid пользователя, чья аватарка в этой строке |
| time | str | время, когда пользователь отправил фото на север |
| ava64 | str | base64 байты аватарки |

### !Войс 
//запущенные войсы, чтобы быстрее отправлять аудио потоки

### !Серверное
//системные настройки, типа последнего id, uid, did и тд, чтобы не парсить при старте сервера

